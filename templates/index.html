{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Main BIN Lookup Card -->
        <div class="card">
            <div class="card-body p-5">
                <div class="text-center mb-4">
                    <h1 class="display-5 fw-bold mb-3">
                        <i class="fab fa-cc-mastercard text-primary me-3"></i>
                        BIN Lookup
                    </h1>
                    <p class="lead text-muted">
                        Enter a Bank Identification Number (BIN) to get detailed card information
                    </p>
                </div>

                <form id="binLookupForm">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="binNumber" class="form-label fw-semibold">
                                    <i class="fas fa-credit-card me-2"></i>
                                    BIN Number
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control form-control-lg" 
                                    id="binNumber" 
                                    placeholder="Enter 6-8 digit BIN number (e.g., 545454)"
                                    maxlength="8"
                                    pattern="[0-9]{6,8}"
                                    required
                                >
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Enter the first 6-8 digits of a credit/debit card
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-search me-2"></i>
                                    Lookup BIN
                                </button>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- Sample BIN Numbers -->
                <div class="mt-4">
                    <h6 class="fw-semibold mb-3">
                        <i class="fas fa-lightbulb me-2"></i>
                        Try these sample BIN numbers:
                    </h6>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-outline-secondary btn-sm" onclick="fillBIN('545454')">545454</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="fillBIN('515555')">515555</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="fillBIN('555555')">555555</button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="fillBIN('424242')">424242</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Container -->
        <div id="resultsContainer" style="display: none;"></div>

        <!-- Account Ranges Section -->
        <div class="card mt-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>
                        Account Ranges
                    </h5>
                    <button class="btn btn-outline-primary" onclick="loadAccountRanges()">
                        <i class="fas fa-refresh me-2"></i>
                        Load Ranges
                    </button>
                </div>
                <div id="accountRangesContainer">
                    <p class="text-muted text-center py-4">
                        <i class="fas fa-info-circle me-2"></i>
                        Click "Load Ranges" to view available account ranges
                    </p>
                </div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title mb-4">
                    <i class="fas fa-search-plus me-2"></i>
                    Advanced Search
                </h5>
                
                <form id="searchForm">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="issuerName" class="form-label">Issuer Name</label>
                                <input type="text" class="form-control" id="issuerName" placeholder="e.g., Chase Bank">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="countryCode" class="form-label">Country Code</label>
                                <input type="text" class="form-control" id="countryCode" placeholder="e.g., US" maxlength="2">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="productType" class="form-label">Product Type</label>
                                <select class="form-select" id="productType">
                                    <option value="">All Types</option>
                                    <option value="CREDIT">Credit</option>
                                    <option value="DEBIT">Debit</option>
                                    <option value="PREPAID">Prepaid</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="fas fa-search me-2"></i>
                        Search BINs
                    </button>
                </form>
                
                <div id="searchResultsContainer" class="mt-4" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // BIN input formatting and validation
    document.getElementById('binNumber').addEventListener('input', function(e) {
        // Only allow digits
        this.value = this.value.replace(/[^0-9]/g, '');
        
        // Add visual feedback
        if (this.value.length >= 6) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else {
            this.classList.remove('is-valid');
            if (this.value.length > 0) {
                this.classList.add('is-invalid');
            }
        }
    });

    // Fill BIN number from sample buttons
    function fillBIN(binNumber) {
        document.getElementById('binNumber').value = binNumber;
        document.getElementById('binNumber').dispatchEvent(new Event('input'));
    }

    // BIN Lookup Form Handler
    document.getElementById('binLookupForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const binNumber = document.getElementById('binNumber').value.trim();
        
        if (!binNumber || binNumber.length < 6) {
            showAlert('Please enter a valid BIN number (6-8 digits)', 'warning');
            return;
        }

        try {
            const data = await apiCall('/lookup', {
                method: 'POST',
                body: JSON.stringify({ bin_number: binNumber })
            });

            displayBINResults(data);
        } catch (error) {
            showAlert(error.message, 'danger');
        }
    });

    // Display BIN lookup results
    function displayBINResults(response) {
        const container = document.getElementById('resultsContainer');
        const data = response.data;

        let html = `
            <div class="card mt-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        BIN Information for ${formatCardNumber(response.bin_number)}
                    </h5>
                </div>
                <div class="card-body">
        `;

        if (data && Object.keys(data).length > 0) {
            html += '<div class="row">';
            
            // Display key information
            const fields = [
                { key: 'issuerName', label: 'Issuer', icon: 'fas fa-university' },
                { key: 'countryCode', label: 'Country', icon: 'fas fa-flag' },
                { key: 'productType', label: 'Product Type', icon: 'fas fa-credit-card' },
                { key: 'cardType', label: 'Card Type', icon: 'fas fa-tags' },
                { key: 'lowAccountRange', label: 'Low Range', icon: 'fas fa-sort-numeric-down' },
                { key: 'highAccountRange', label: 'High Range', icon: 'fas fa-sort-numeric-up' }
            ];

            fields.forEach(field => {
                if (data[field.key]) {
                    html += `
                        <div class="col-md-6 mb-3">
                            <div class="d-flex align-items-center">
                                <i class="${field.icon} text-primary me-3"></i>
                                <div>
                                    <small class="text-muted">${field.label}</small>
                                    <div class="fw-semibold">${data[field.key]}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            html += '</div>';

            // Display raw JSON for developers
            html += `
                <div class="mt-4">
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#rawData">
                        <i class="fas fa-code me-2"></i>
                        Show Raw Data
                    </button>
                    <div class="collapse mt-3" id="rawData">
                        <pre class="bg-light p-3 rounded"><code>${JSON.stringify(data, null, 2)}</code></pre>
                    </div>
                </div>
            `;
        } else {
            html += `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                    <h5>No Data Found</h5>
                    <p class="text-muted">No information available for this BIN number.</p>
                </div>
            `;
        }

        html += '</div></div>';
        
        container.innerHTML = html;
        container.style.display = 'block';
        
        // Scroll to results
        container.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Load Account Ranges
    async function loadAccountRanges() {
        try {
            const data = await apiCall('/ranges?page=1&size=10');
            displayAccountRanges(data.data);
        } catch (error) {
            showAlert('Failed to load account ranges: ' + error.message, 'danger');
        }
    }

    // Display Account Ranges
    function displayAccountRanges(data) {
        const container = document.getElementById('accountRangesContainer');
        
        if (!data || !data.content || data.content.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-inbox text-muted fa-3x mb-3"></i>
                    <h6>No Account Ranges Found</h6>
                    <p class="text-muted">No account range data available.</p>
                </div>
            `;
            return;
        }

        let html = `
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Low Range</th>
                            <th>High Range</th>
                            <th>Issuer</th>
                            <th>Country</th>
                            <th>Product Type</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        data.content.forEach(range => {
            html += `
                <tr>
                    <td><code>${formatCardNumber(range.lowAccountRange || 'N/A')}</code></td>
                    <td><code>${formatCardNumber(range.highAccountRange || 'N/A')}</code></td>
                    <td>${range.issuerName || 'N/A'}</td>
                    <td>${range.countryCode || 'N/A'}</td>
                    <td>
                        <span class="badge bg-primary">${range.productType || 'N/A'}</span>
                    </td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
        `;

        // Add pagination info
        if (data.totalElements) {
            html += `
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <small class="text-muted">
                        Showing ${data.numberOfElements} of ${data.totalElements} results
                    </small>
                    <small class="text-muted">
                        Page ${data.number + 1} of ${data.totalPages}
                    </small>
                </div>
            `;
        }

        container.innerHTML = html;
    }

    // Search Form Handler
    document.getElementById('searchForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const issuerName = document.getElementById('issuerName').value.trim();
        const countryCode = document.getElementById('countryCode').value.trim();
        const productType = document.getElementById('productType').value;

        if (!issuerName && !countryCode && !productType) {
            showAlert('Please enter at least one search criteria', 'warning');
            return;
        }

        try {
            const params = new URLSearchParams();
            if (issuerName) params.append('issuer_name', issuerName);
            if (countryCode) params.append('country_code', countryCode);
            if (productType) params.append('product_type', productType);
            params.append('size', '10');

            const data = await apiCall(`/search?${params.toString()}`);
            displaySearchResults(data.data);
        } catch (error) {
            showAlert('Search failed: ' + error.message, 'danger');
        }
    });

    // Display Search Results
    function displaySearchResults(data) {
        const container = document.getElementById('searchResultsContainer');
        
        if (!data || !data.content || data.content.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-search me-2"></i>
                    No results found for your search criteria.
                </div>
            `;
            container.style.display = 'block';
            return;
        }

        let html = `
            <h6 class="mb-3">Search Results (${data.totalElements} found)</h6>
            <div class="row">
        `;

        data.content.forEach(result => {
            html += `
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">${result.issuerName || 'Unknown Issuer'}</h6>
                            <p class="card-text">
                                <small class="text-muted">Range:</small><br>
                                <code>${formatCardNumber(result.lowAccountRange)} - ${formatCardNumber(result.highAccountRange)}</code>
                            </p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-secondary">${result.countryCode || 'N/A'}</span>
                                <span class="badge bg-primary">${result.productType || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        html += '</div>';
        
        container.innerHTML = html;
        container.style.display = 'block';
    }
</script>
{% endblock %}